// ✅ 노을빛하루 - 완전교체용 server.js (전 주제 12개 + affiliate.json 핫리로드)
// 루트에 affiliate.json, index.html, question.html, result.html이 함께 있어야 함.

const express = require("express");
const fs = require("fs");
const path = require("path");
const app = express();

app.use(express.json());
app.use(express.static(__dirname));

// ==============================
// 1) affiliate.json 자동 로드 + 핫리로드
// ==============================
let affiliateData = {};
const affiliatePath = path.join(__dirname, "affiliate.json");

function loadAffiliate() {
  try {
    const raw = fs.readFileSync(affiliatePath, "utf8");
    affiliateData = JSON.parse(raw);
    console.log("✅ affiliate.json 로드 완료");
  } catch (err) {
    console.error("❌ affiliate.json 로드 실패:", err.message);
    affiliateData = {};
  }
}
loadAffiliate();

fs.watchFile(affiliatePath, { interval: 1000 }, () => {
  console.log("♻️ affiliate.json 변경 감지 → 재로드");
  loadAffiliate();
});

// ==============================
// 2) 정적 라우팅
// ==============================
app.get("/", (req, res) => res.sendFile(path.join(__dirname, "index.html")));
app.get("/question.html", (req, res) => res.sendFile(path.join(__dirname, "question.html")));
app.get("/result", (req, res) => res.sendFile(path.join(__dirname, "result.html")));

// ==============================
// 3) 진단 엔진
// ==============================
function analyzeTopic(topic, checks = []) {
  // 공통 위험어 + 토픽 보정 키워드
  const riskWords = [
    "심함","악화","위험","즉시","갑자기","숨","통증","저림","어지럼","가슴","불면","기억","혈당","혈압","응급"
  ];
  const topicBoost = {
    "관절 통증": ["무릎","어깨","붓기","열감","걷기","계단","연골","MRI"],
    "혈압 관리": ["두통","어지럼","코피","부종","심장","가슴","맥박"],
    "혈당·당뇨": ["갈증","다뇨","피로","상처","시야","저림","공복","식후"],
    "불면증·수면장애": ["새벽각성","우울","불안","코골이","무호흡","깨어남"],
    "어깨·목 통증": ["경추","디스크","팔저림","두통","거북목","자세"],
    "심장·호흡·가슴통증": ["협심증","부정맥","호흡곤란","식은땀","압박감","응급"],
    "노안·시력저하": ["야간","빛번짐","건조","눈물","독서","초점"],
    "치매·기억력 문제": ["길잃음","물건분실","혼동","낯익음","인지","검사"],
    "전립선·배뇨 문제": ["야간뇨","잔뇨감","통증","열감","혈뇨","급뇨"],
    "종합 건강 체크": ["체중변화","무기력","식욕","수면부족","과로","스트레스"],
    "보험비용 종합점검": ["갱신","특약","중복","해지환급","보장공백","납입"],
    "최저가 자동차 견적 비교": ["리스","렌트","보험료","세금","유지비","과금"]
  };

  let riskScore = 0;
  const pool = [...riskWords, ...(topicBoost[topic] || [])];
  checks.forEach(c => pool.forEach(w => { if (typeof c === "string" && c.includes(w)) riskScore++; }));

  // 가중치 → 30~100 범위 클램프
  const riskPercent = Math.max(0, Math.min(100, 30 + riskScore * 7));
  const level = riskPercent >= 70 ? "위험 (Severe)" : riskPercent >= 45 ? "주의 (Moderate)" : "양호 (Mild)";

  // ==============================
  // 4) 토픽별 컨텐츠 (상세 10줄 / 요약 7줄 / 의견 2줄)
  // ==============================
  const T = {
    "관절 통증": {
      detail: [
        "관절 연골의 마찰이 늘어나 통증 유발 가능성이 있습니다.",
        "무릎·손목·어깨 사용량이 높은 날 증상이 심해질 수 있습니다.",
        "체중 부하가 큰 동작에서 통증이 가중될 수 있습니다.",
        "부종·열감·움직임 제한이 동반되면 염증 가능성이 높습니다.",
        "초기에는 근육통과 구분이 어려워 방치되기 쉽습니다.",
        "장시간 서있기·계단 오르내리기는 피하는 것이 좋습니다.",
        "온찜질과 가벼운 스트레칭이 통증 완화에 도움 됩니다.",
        "걷기는 평지를 선택하고 보조보행을 고려할 수 있습니다.",
        "3일 이상 통증 지속 시 X-ray 또는 초음파 검사가 유익합니다.",
        "통증 악화 시 즉시 정형외과 진료를 권장합니다."
      ],
      summary: [
        "관절 마찰·염증 가능성",
        "체중 부하 줄이기",
        "평지 위주 보행 권장",
        "온찜질·스트레칭 병행",
        "붓기·열감 시 병원",
        "3일 이상 지속 시 검사",
        "무리한 활동 피하기"
      ],
      opinion: [
        "‘통증 기록’과 체중 관리가 예후에 중요합니다.",
        "반복 통증이면 정형외과에서 영상검사를 권합니다."
      ]
    },
    "혈압 관리": {
      detail: [
        "염분 섭취·스트레스·수면 부족이 혈압 변동에 큰 영향을 줍니다.",
        "기상 직후 측정 수치가 높게 나오는 경향이 있습니다.",
        "두통·어지럼이 반복되면 고혈압 전단계 가능성이 있습니다.",
        "카페인·알코올이 수치를 일시적으로 끌어올릴 수 있습니다.",
        "유산소 운동과 체중 감량이 수치 안정에 효과적입니다.",
        "칼륨·마그네슘 섭취가 혈관 이완에 도움 됩니다.",
        "수축기/이완기 모두 안정 범위인지 함께 확인해야 합니다.",
        "가정용 혈압계로 같은 시간대에 기록 습관을 권장합니다.",
        "수치가 며칠간 높게 유지되면 약물 조정이 필요할 수 있습니다.",
        "응급 증상 동반 시 즉시 의료기관 내원이 필요합니다."
      ],
      summary: [
        "염분·스트레스·수면 영향",
        "유산소+체중관리 필수",
        "카페인·음주 줄이기",
        "가정혈압 기록 습관화",
        "수치 지속 상승 시 진료",
        "미네랄 섭취 도움",
        "응급 증상 즉시 내원"
      ],
      opinion: [
        "저염식과 규칙 운동이 가장 확실한 개입입니다.",
        "혈압 변동이 잦으면 내과 상담을 권장합니다."
      ]
    },
    "혈당·당뇨": {
      detail: [
        "단 음식·야식·불규칙 식사로 혈당 변동폭이 커질 수 있습니다.",
        "식후 졸림·피로·갈증·다뇨는 조절 불균형 신호일 수 있습니다.",
        "수면 부족·스트레스가 인슐린 저항성을 높입니다.",
        "공복 혈당·식후 2시간 혈당 모두 추적이 필요합니다.",
        "걷기·근력운동은 인슐린 감수성 향상에 기여합니다.",
        "섬유질 섭취는 식후 혈당 급등을 완화합니다.",
        "체중·허리둘레 관리가 예후에 중요합니다.",
        "상처 치유 지연·시야 흐림 동반 시 합병증 의심됩니다.",
        "수치가 지속 상승하면 약물치료가 필요할 수 있습니다.",
        "내분비내과 정기 추적을 권장합니다."
      ],
      summary: [
        "식습관·운동이 핵심",
        "수면·스트레스 관리",
        "공복/식후 혈당 체크",
        "섬유질·단당류 조절",
        "체중·허리둘레 관리",
        "증상 지속 시 내원",
        "합병증 신호 주의"
      ],
      opinion: [
        "식후 30분 걷기가 혈당 안정에 특히 유익합니다.",
        "수치 기록을 의사와 공유해 조기 개입을 받으세요."
      ]
    },
    "불면증·수면장애": {
      detail: [
        "취침 전 스크린 노출은 멜라토닌 분비를 억제합니다.",
        "새벽각성·입면 지연은 스트레스 축적과 연관됩니다.",
        "카페인·니코틴은 수면 유지에 방해가 됩니다.",
        "불규칙 취침·기상 시간은 수면 리듬을 깨뜨립니다.",
        "낮잠이 길면 밤 수면 압력이 낮아질 수 있습니다.",
        "코골이·무호흡 의심 시 수면검사가 필요합니다.",
        "수면 위생 수칙(조도·온도·소음) 조정이 중요합니다.",
        "이완 호흡·명상·저강도 스트레칭이 도움 됩니다.",
        "2주 이상 지속 시 전문의 상담을 권합니다.",
        "우울·불안 동반 시 병행 치료가 필요할 수 있습니다."
      ],
      summary: [
        "스크린·카페인 조절",
        "취침·기상 고정하기",
        "수면 위생 환경 정비",
        "호흡·명상 병행",
        "수면무호흡 의심 검사",
        "2주 지속 시 진료",
        "우울·불안 동시 평가"
      ],
      opinion: [
        "취침 2시간 전 스크린 오프가 효과적입니다.",
        "수면일지를 작성해 패턴을 파악하세요."
      ]
    },
    "어깨·목 통증": {
      detail: [
        "장시간 앉은 자세가 근막긴장과 통증을 유발합니다.",
        "거북목·라운드숄더는 경추 부담을 높입니다.",
        "팔 저림·감각이상은 신경 압박 신호일 수 있습니다.",
        "작은 모니터·높은 키보드는 경추 전만을 깨뜨립니다.",
        "온열·스트레칭·자세 교정이 1차 개입입니다.",
        "증상 지속 시 물리치료·도수치료가 도움 됩니다.",
        "야간 통증 악화는 디스크·협착 의심됩니다.",
        "업무 중 마이크로 브레이크를 권장합니다.",
        "수면자세(높은 베개)는 악화 요인일 수 있습니다.",
        "신경학적 결손 시 즉시 영상검사를 권합니다."
      ],
      summary: [
        "자세 불균형 핵심 원인",
        "온열+스트레칭 우선",
        "업무 중 자주 휴식",
        "모니터/의자 높이 조절",
        "팔저림·감각이상 주의",
        "야간 악화 시 검사",
        "도수·물리치료 고려"
      ],
      opinion: [
        "키보드·모니터 높이를 표준 인체공학에 맞추세요.",
        "팔 저림 지속 시 정형외과/신경외과 진료 권장."
      ]
    },
    "심장·호흡·가슴통증": {
      detail: [
        "운동 시 가슴 압박감은 협심증 가능성이 있습니다.",
        "불규칙 맥박·어지럼은 부정맥 신호일 수 있습니다.",
        "식은땀·호흡곤란은 응급 징후에 해당합니다.",
        "가슴통증이 3분 이상 지속되면 즉시 내원 필요.",
        "위식도 역류도 흉통을 유발할 수 있어 감별이 필요합니다.",
        "고혈압·당뇨·흡연력은 심혈관 위험 요인입니다.",
        "심전도·효소검사·흉부영상이 진단에 유용합니다.",
        "휴식 시 호전/악화 패턴을 기록하면 도움 됩니다.",
        "가족력 있으면 조기검진 필요성이 큽니다.",
        "증상 첫 발생 시각을 기록해 의사에게 전달하세요."
      ],
      summary: [
        "협심증·부정맥 가능성",
        "호흡곤란·식은땀 응급",
        "3분 이상 통증 시 내원",
        "위식도역류 감별 필요",
        "심전도·효소검사 유용",
        "위험요인: 고혈압·당뇨",
        "가족력 있으면 조기검진"
      ],
      opinion: [
        "응급 징후가 보이면 119 혹은 응급실을 이용하세요.",
        "통증 일지로 유발 상황을 파악하세요."
      ]
    },
    "노안·시력저하": {
      detail: [
        "장시간 근거리 작업은 조절력 피로를 유발합니다.",
        "야간 빛번짐·눈부심은 수정체 변화 신호일 수 있습니다.",
        "안구건조는 이물감·시야 흐림을 동반합니다.",
        "블루라이트 과노출은 피로 누적을 가속합니다.",
        "20-20-20 규칙이 증상 완화에 효과적입니다.",
        "루테인·오메가3 섭취가 도움 될 수 있습니다.",
        "인공눈물·가습으로 건조 환경을 개선하세요.",
        "1년에 한 번 시력검진이 권장됩니다.",
        "야간 운전 어려움은 조기 검사 신호입니다.",
        "백내장·망막질환 의심 시 즉시 안과 진료가 필요합니다."
      ],
      summary: [
        "근거리 과다 → 피로",
        "건조·빛번짐 동반 가능",
        "블루라이트 노출 줄이기",
        "20-20-20 실천",
        "영양·인공눈물 도움",
        "연 1회 검진 권장",
        "증상 악화 즉시 내원"
      ],
      opinion: [
        "조명·화면 밝기를 눈에 편한 수준으로 맞추세요.",
        "야간 시야 저하는 지체 없이 검사를 권합니다."
      ]
    },
    "치매·기억력 문제": {
      detail: [
        "최근 기억 저하·집중력 저하는 경도인지장애 신호일 수 있습니다.",
        "길 찾기 어려움·물건 자주 분실은 위험 신호입니다.",
        "수면 부족·우울·불안이 인지기능을 저하시킵니다.",
        "고혈압·당뇨·지질이상은 치매 위험 요인입니다.",
        "두뇌 자극 활동(독서·퍼즐)이 보호 효과가 있습니다.",
        "사회적 교류 감소는 진행 위험을 높일 수 있습니다.",
        "B12·갑상선 등 가역 원인 감별이 필요합니다.",
        "3개월 이내 인지기능 검사를 권장합니다.",
        "운동·지중해식 식단이 예방에 도움 됩니다.",
        "가족의 관찰과 조기 개입이 중요합니다."
      ],
      summary: [
        "경도인지 의심 신호",
        "수면·우울·불안 관리",
        "혈관성 위험요인 관리",
        "두뇌 자극 활동 권장",
        "가역 원인 감별 필요",
        "3개월 내 인지검사",
        "가족 관찰·조기 개입"
      ],
      opinion: [
        "규칙적 운동과 독서·퍼즐을 일상화하세요.",
        "변화가 지속되면 신경과에서 평가 받으세요."
      ]
    },
    "전립선·배뇨 문제": {
      detail: [
        "야간뇨·약한 줄기·잔뇨감은 전립선 비대의 흔한 증상입니다.",
        "통증·열감·혈뇨 동반 시 염증 가능성이 큽니다.",
        "카페인·알코올은 증상을 악화시킬 수 있습니다.",
        "수분 섭취 시간 조절로 야간뇨를 줄일 수 있습니다.",
        "초음파·요속검사로 상태 평가가 가능합니다.",
        "과민성 방광과의 감별이 필요합니다.",
        "골반저 근육운동이 보조적으로 도움 됩니다.",
        "약물치료로 증상 완화가 가능합니다.",
        "급성 악화 시 요폐 위험에 유의해야 합니다.",
        "발열·오한 동반 시 즉시 내원하세요."
      ],
      summary: [
        "전립선 비대 흔한 원인",
        "카페인·알코올 제한",
        "야간 수분 조절하기",
        "초음파·요속검사 유용",
        "골반저 운동 보조적",
        "약물치료로 완화 가능",
        "발열·혈뇨 즉시 내원"
      ],
      opinion: [
        "1주 이상 불편 지속 시 비뇨기과 상담을 권합니다.",
        "생활 습관 교정과 약물 병행이 효과적입니다."
      ]
    },
    "종합 건강 체크": {
      detail: [
        "체중 변화·무기력은 생활 불균형 신호일 수 있습니다.",
        "수면의 질 저하는 면역·대사 기능에 영향을 줍니다.",
        "과로·스트레스는 피로 누적의 주된 원인입니다.",
        "규칙적 운동이 에너지 회복에 기여합니다.",
        "균형 잡힌 식사가 기초 대사를 안정화합니다.",
        "수분 섭취 부족은 피로를 악화시킬 수 있습니다.",
        "비타민·미네랄 부족을 점검해야 합니다.",
        "정기 건강검진으로 위험요인을 조기 발견하세요.",
        "우울·불안 체크도 함께 고려하세요.",
        "작은 습관 교정이 전체 컨디션을 끌어올립니다."
      ],
      summary: [
        "수면·식사·운동 재정비",
        "수분 섭취 늘리기",
        "미량영양소 점검",
        "정기 검진으로 조기발견",
        "스트레스 관리 필수",
        "작은 습관부터 교정",
        "우울·불안도 체크"
      ],
      opinion: [
        "피로가 2주 이상 지속되면 검사를 권합니다.",
        "수면·식사·운동 루틴을 2주간 실험해 보세요."
      ]
    },
    "보험비용 종합점검": {
      detail: [
        "갱신형 특약 비중이 높으면 장기 비용이 커질 수 있습니다.",
        "중복 보장은 납입 효율을 떨어뜨립니다.",
        "보장 공백은 위기 시 실질 보상을 어렵게 합니다.",
        "해지환급금 구조를 이해하고 유지/조정 결정을 하세요.",
        "필요 담보 위주로 단순화가 비용 효율적입니다.",
        "실손 보장은 최신 약관으로 점검이 필요합니다.",
        "생애주기 변화(자녀 독립·은퇴)에 맞춘 리모델링이 유익합니다.",
        "최근 1년 사고이력·변경사항을 확인하세요.",
        "납입 여력을 초과하면 재무 리스크가 발생합니다.",
        "전문가 2인 이상 비교 상담을 권합니다."
      ],
      summary: [
        "갱신형 비중 점검",
        "중복 보장 정리",
        "보장 공백 확인",
        "해지환급 구조 이해",
        "실손 약관 최신화",
        "생애주기 맞춤 리모델링",
        "2인 이상 비교상담"
      ],
      opinion: [
        "월 납입은 소득의 10~15% 이내로 관리하세요.",
        "불필요 특약은 과감히 정리하는 게 좋습니다."
      ]
    },
    "최저가 자동차 견적 비교": {
      detail: [
        "렌트·리스는 보험료·세금 포함 총비용으로 비교해야 합니다.",
        "보증금·잔존가치 조건에 따라 월 납입이 크게 달라집니다.",
        "주행거리 제한·초과요금 조건을 확인하세요.",
        "정비 포함 여부가 실제 비용에 큰 영향을 줍니다.",
        "개인사업자·법인 조건이 유리할 수 있습니다.",
        "반납·중도해지 수수료를 반드시 확인하세요.",
        "보험 담보 수준에 따라 리스크가 달라집니다.",
        "견적은 최소 2~3곳 이상 비교가 필요합니다.",
        "가성비 트림·옵션 선택이 총비용을 낮춥니다.",
        "장기 금융부담이 소득 대비 과도하지 않은지 점검하세요."
      ],
      summary: [
        "총비용(TCO)로 비교",
        "보증금·잔가 조건 체크",
        "주행제한·정비 포함 확인",
        "반납·해지 수수료 주의",
        "보험 담보 수준 중요",
        "2~3곳 이상 견적 비교",
        "소득 대비 납입 검토"
      ],
      opinion: [
        "월 납입은 순소득의 15% 이내를 권장합니다.",
        "실사용 거리 기준으로 리스/렌트를 선택하세요."
      ]
    }
  };

  const base = T[topic] || {
    detail: ["상세 진단 데이터 없음."],
    summary: ["요약 데이터 없음."],
    opinion: ["전문가 의견 데이터 없음."]
  };

  // 제휴상품(오른쪽 카드)용: result.html은 이름만 쓰므로 여기선 이름 배열로 반환
  const supplements = (affiliateData[topic] || []).map(x => x.name);

  return {
    topic,
    level,
    riskPercent,
    detail: base.detail,      // 배열 (10줄)
    summary: base.summary,    // 배열 (7줄)
    opinion: base.opinion,    // 배열 (2줄)
    supplements               // 배열 (이름들)
  };
}

// ==============================
// 5) API
// ==============================
app.post("/api/analyze", (req, res) => {
  const { topic, checks } = req.body || {};
  if (!topic || !Array.isArray(checks)) {
    return res.status(400).json({ error: "잘못된 요청입니다. topic(string)과 checks(array)가 필요합니다." });
    }
  return res.json(analyzeTopic(topic, checks));
});

// ==============================
// 6) 서버 시작
// ==============================
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`🚀 노을빛하루 서버 실행 중 http://localhost:${PORT}`);
});
