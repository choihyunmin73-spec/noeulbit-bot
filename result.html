<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>AI 진단 결과</title>
<style>
  :root{--bg:#0d1420;--panel:#121a26;--panel2:#182235;--line:#2a3a55;--brand:#6ba7ff;--muted:#9fb1cf;--white:#fff;}
  body{font-family:"Pretendard","Noto Sans KR",sans-serif;background:var(--bg);color:var(--white);margin:0}
  .wrap{max-width:1180px;margin:0 auto;padding:26px 32px 40px}
  h1{margin:6px 0 18px;color:#98c2ff}
  .grid{display:grid;grid-template-columns:1.7fr .9fr;gap:26px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px}
  .chip{display:inline-block;background:#1f2b44;border:1px solid #2f4570;padding:6px 10px;border-radius:999px;font-size:13px;color:#cfe2ff;margin-right:8px}
  .bar{height:8px;border-radius:4px;background:#23304a;overflow:hidden;margin-top:8px}
  .bar>span{display:block;height:100%;width:0;background:#6ba7ff;transition:width .6s}
  h3.sec{color:#9eb2ff;border-left:3px solid var(--brand);padding-left:8px;margin:18px 0 8px}
  ul{margin:8px 0 12px 20px}
  li{margin:4px 0}
  .twoBtn{display:flex;gap:12px;margin-top:16px}
  .btn{display:inline-block;background:#294e80;border:1px solid #3d6bb0;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none}
  .aff{display:flex;align-items:flex-start;gap:12px;background:#1f2531;border:1px solid #283142;border-radius:12px;padding:14px;cursor:pointer;transition:.2s;margin-bottom:12px}
  .aff:hover{transform:translateY(-2px);background:#232c3d}
  .aff img{width:26px;height:26px}
  .muted{color:#98a0b3}
  .tiny{font-size:12px;color:#8c95a8;margin-top:6px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <h1>AI 진단 결과</h1>
    <div class="grid">
      <!-- LEFT -->
      <section class="card" id="left">
        <div class="chip" id="topic">주제: 불러오는 중...</div>
        <div class="chip" id="level">-</div>
        <div class="chip">총 응답 수: <span id="ans">0</span></div>
        <div class="chip">위험단어 수: <span id="rk">0</span></div>
        <div class="chip">위험도 지표: <span id="risk">0</span>/100</div>
        <div class="bar"><span id="riskBar"></span></div>

        <h3 class="sec">상세 진단</h3>
        <ul id="detail"><li class="muted">AI 분석 중입니다...</li></ul>

        <h3 class="sec">요약</h3>
        <ul id="summary"><li class="muted">AI 분석 중입니다...</li></ul>

        <h3 class="sec">전문가 의견</h3>
        <ul id="opinion"><li class="muted">AI 분석 중입니다...</li></ul>

        <div class="twoBtn">
          <a class="btn" href="index.html">처음으로 돌아가기</a>
          <a class="btn" href="question.html">다시 진단하기</a>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card" id="right">
        <h3 class="sec">제휴상품 (필요하신 영양제)</h3>
        <div id="supps"><div class="muted">로딩 중...</div></div>
        <div class="tiny">본 제휴상품 및 제휴보험은 소정의 수수료를 지급받습니다.</div>

        <h3 class="sec">제휴보험 (체크해 보세요)</h3>
        <div id="ins"></div>
      </aside>
    </div>
  </div>

<script>
(async function(){
  const topic = localStorage.getItem("aiTopic");
  const answers = JSON.parse(localStorage.getItem("aiAnswers") || "[]");
  const $ = id => document.getElementById(id);

  if(!topic || answers.length===0){
    $("detail").innerHTML = `<li class="muted">결과 데이터를 불러올 수 없습니다.</li>`;
    return;
  }

  $("topic").textContent = `주제: ${topic}`;
  $("ans").textContent = answers.length;

  try {
    // ✅ GPT 분석 호출
    const res = await fetch("/analyze", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({topic, answers})
    });
    const data = await res.json();

    if(!data.ok) throw new Error("AI 분석 실패");
    const result = data.result;

    // 결과 표시
    const det = (result.detail || "").split(/[\n•]/).filter(t=>t.trim());
    const sum = (result.summary || "").split(/[\n•]/).filter(t=>t.trim());
    const opn = (result.expert || "").split(/[\n•]/).filter(t=>t.trim());

    $("detail").innerHTML = det.map(s=>`<li>${s.trim()}</li>`).join("") || `<li class="muted">데이터 없음</li>`;
    $("summary").innerHTML = sum.map(s=>`<li>${s.trim()}</li>`).join("") || `<li class="muted">데이터 없음</li>`;
    $("opinion").innerHTML = opn.map(s=>`<li>${s.trim()}</li>`).join("") || `<li class="muted">데이터 없음</li>`;

    // ✅ 단순 점수 계산 (위험어 기준)
    if (answers && answers.length > 0) {
      const riskWords = ["심함","위험","통증","저림","호흡","가슴","불안","어지럼","높음","즉시"];
      let riskCount = 0;
      answers.forEach(a => {
        riskWords.forEach(w => {
          if (a.includes(w)) riskCount++;
        });
      });
      const riskPercent = Math.min(100, Math.round((riskCount / (answers.length * 2)) * 100));
      $("rk").textContent = riskCount;
      $("risk").textContent = riskPercent;
      $("riskBar").style.width = riskPercent + "%";
      $("level").textContent =
        riskPercent < 30 ? "mild" :
        riskPercent < 70 ? "moderate" : "high";
    } else {
      $("rk").textContent = "0";
      $("risk").textContent = "0";
      $("riskBar").style.width = "0%";
      $("level").textContent = "mild";
    }

  } catch(e){
    console.error(e);
    $("detail").innerHTML = `<li class="muted">AI 분석 중 오류가 발생했습니다.</li>`;
  }

  // ✅ 제휴상품 불러오기
  try {
    const res2 = await fetch("/affiliate-live");
    const map = await res2.json();
    const list = map[topic] || [];
    const box = $("supps");

    if(!list.length){
      box.innerHTML = `<div class="muted">해당 주제에 등록된 제휴상품이 없습니다.</div>`;
    } else {
      box.innerHTML = "";
      list.slice(0,3).forEach(item=>{
        const d = document.createElement("div");
        d.className = "aff";
        d.innerHTML = `
          <img src="https://cdn-icons-png.flaticon.com/512/2965/2965567.png" alt="pill">
          <div>
            <div><strong>${item.name}</strong></div>
            <div class="muted">${item.desc||""}</div>
            <div class="muted">쿠팡 바로가기</div>
          </div>`;
        d.onclick = ()=>window.open(item.link,"_blank");
        box.appendChild(d);
      });
    }
  } catch(err){
    $("supps").innerHTML = `<div class="muted">제휴상품 정보를 불러오지 못했습니다.</div>`;
  }

  // ✅ 제휴보험 고정 출력
  const ins = $("ins");
  [
    {name:"고혈압·심장 보장보험", desc:"혈압·심혈관질환 중심 보장 상품"},
    {name:"만성질환 실손보험",   desc:"정기 내과·검사비 보장 상품"}
  ].forEach(i=>{
    const d = document.createElement("div");
    d.className = "aff";
    d.innerHTML = `
      <img src="https://cdn-icons-png.flaticon.com/512/2965/2965401.png" alt="shield">
      <div>
        <div><strong>${i.name}</strong></div>
        <div class="muted">${i.desc}</div>
      </div>`;
    ins.appendChild(d);
  });
})();
</script>
</body>
</html>
