<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>노을빛하루 AI 건강진단 설문</title>
<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    margin: 0;
    background: #f6f7f9;
  }
  header {
    background: #0e1116;
    color: #fff;
    padding: 20px;
    text-align: center;
  }
  .container {
    max-width: 900px;
    margin: 30px auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 6px 16px rgba(0,0,0,.08);
    padding: 24px;
  }
  h2 {
    margin: 0 0 20px;
    text-align: center;
    font-size: 22px;
  }
  .q {
    border-bottom: 1px solid #eee;
    padding: 16px 0;
  }
  .q:last-child {
    border-bottom: none;
  }
  .q strong {
    color: #111;
  }
  .opts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 12px;
  }
  label {
    background: #f2f4f6;
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 15px;
    transition: all .2s;
  }
  label:hover {
    background: #dde3ea;
  }
  input[type="radio"] {
    margin-right: 6px;
  }
  .submit {
    text-align: center;
    margin-top: 24px;
  }
  button {
    background: #0e1116;
    color: #fff;
    font-weight: 700;
    border: 0;
    padding: 12px 20px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 16px;
  }
  .info {
    text-align: center;
    color: #555;
    font-size: 14px;
    margin-bottom: 20px;
  }
  @media (max-width:680px){
    .opts { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<header>
  <h1>노을빛하루 AI 건강진단</h1>
</header>

<div class="container">
  <div class="info" id="info"></div>
  <h2 id="title">설문을 불러오는 중입니다...</h2>
  <form id="form"></form>
  <div class="submit">
    <button id="go">진단 결과 보기</button>
  </div>
</div>

<script>
// ===============================
// URL 파라미터로 주제(topic) 받기
// ===============================
const params = new URLSearchParams(location.search);
const topic = params.get("topic");
const infoBox = document.getElementById("info");
const title = document.getElementById("title");
const form = document.getElementById("form");

// ===============================
// 설문 로드 함수
// ===============================
async function loadSurvey() {
  if (!topic) {
    title.textContent = "주제를 선택해주세요.";
    return;
  }

  infoBox.textContent = `${topic} 진단 문항을 준비 중입니다. 잠시만 기다려주세요...`;
  title.textContent = `${topic} 진단`;

  try {
    const res = await fetch(`/api/survey?topic=${encodeURIComponent(topic)}`);
    if (!res.ok) throw new Error("설문을 불러오지 못했습니다.");
    const data = await res.json();

    // 문항 표시 초기화
    form.innerHTML = "";
    infoBox.textContent = `총 ${data.questions.length}문항이 준비되었습니다.`;

    data.questions.forEach((q, i) => {
      const div = document.createElement("div");
      div.className = "q";

      // ✅ 문항 텍스트 정상 표시
      div.innerHTML = `<div><strong>문항 ${i + 1}.</strong> ${q.text}</div>`;

      const opts = document.createElement("div");
      opts.className = "opts";

      // ✅ 보기별 출력 (6개 이상 자동)
      q.options.forEach((op, idx) => {
        const id = `${q.id}_${idx}`;
        opts.innerHTML += `
          <label>
            <input type="radio" name="${q.id}" value="${op}" required>
            ${op}
          </label>
        `;
      });

      div.appendChild(opts);
      form.appendChild(div);
    });

    // ✅ 결과 페이지 이동 로직
    document.getElementById("go").onclick = async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const answers = data.questions.map(q => fd.get(q.id));

      const resp = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ topic, answers })
      });

      if (!resp.ok) {
        alert("결과 분석에 실패했습니다.");
        return;
      }

      const result = await resp.json();
      sessionStorage.setItem("latestResult", JSON.stringify(result));
      location.href = `result.html?topic=${encodeURIComponent(topic)}`;
    };

  } catch (err) {
    console.error(err);
    title.textContent = "설문 로드 중 오류가 발생했습니다.";
  }
}

// ===============================
// 로드 실행
// ===============================
loadSurvey();
</script>
</body>
</html>
