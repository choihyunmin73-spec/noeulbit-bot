// server.js  — CommonJS (require) 버전
const express = require("express");
const path = require("path");

const app = express();
app.use(express.json());
app.use(express.static(__dirname));

// ---------- 정적 라우팅 ----------
app.get("/", (req, res) => res.sendFile(path.join(__dirname, "index.html")));
app.get("/question", (req, res) => res.sendFile(path.join(__dirname, "question.html")));
app.get("/result", (req, res) => res.sendFile(path.join(__dirname, "result.html")));

// ---------- 분석 로직 ----------
app.post("/analyze", (req, res) => {
  const { topic = "종합 건강 체크", checks = [] } = req.body;

  // 간단 점수 매핑 (키워드 존재 시 가중치)
  let score = 0;
  const has = (kw) => checks.some((c) => String(c).includes(kw));
  const add = (cond, p) => { if (cond) score += p; };

  add(has("지속"), 2);
  add(has("악화"), 2);
  add(has("심해"), 2);
  add(has("열감"), 1);
  add(has("붓"), 1);
  add(has("숨"), 2);
  add(has("두근"), 2);
  add(has("가슴"), 2);
  add(has("야간"), 1);
  add(has("일상"), 1);
  add(has("자주"), 1);
  add(has("고혈압"), 1);
  add(has("당뇨"), 1);

  const severity = score >= 7 ? "높음" : score >= 4 ? "중간" : "낮음";
  const action =
    severity === "높음"
      ? "가까운 병·의원 내원 권장(1주 이내). 흉통·호흡곤란 등 급격 악화 시 즉시 119."
      : severity === "중간"
      ? "생활관리 우선 + 1–2주 내 상담 권장."
      : "자가관리 우선. 증상 변화 추적.";

  const dept = {
    "관절 통증": "정형외과 / 류마티스내과",
    "혈압 관리": "가정의학과 / 내과",
    "혈당·당뇨": "내분비내과",
    "불면증·수면장애": "신경과 / 정신건강의학과 / 수면의학센터",
    "어깨·목 통증": "정형외과 / 재활의학과",
    "심장·호흡·가슴통증": "심장내과 / 호흡기내과 (응급 시 응급실)",
    "노안·시력저하": "안과",
    "치매·기억력 문제": "신경과 / 노인정신의학과",
    "전립선·배뇨 문제": "비뇨의학과",
    "종합 건강 체크": "가정의학과",
    "보이스피싱 예방": "(의료 아님) 금융기관 고객센터",
    "복지·생활지원금": "관할 행정복지센터",
  }[topic] || "가정의학과";

  const tipsMap = {
    "관절 통증": [
      "48시간 냉찜질(통증/부기 시) 하루 3회 10–15분",
      "통증 유발 동작 피하고 가벼운 가동범위 운동",
      "진통소염제·파스 과용 금지",
      "계단/오르막 줄이기",
    ],
    "혈압 관리": [
      "가정혈압: 아침·저녁 5분 안정 후 2회 기록",
      "염분 5g/일 이하(국물·젓갈 줄이기)",
      "매일 30분 걷기",
      "약은 같은 시간에, 임의 중단 금지",
    ],
    "혈당·당뇨": [
      "공복/식후2시간 혈당 기록",
      "정제탄수 줄이고 단백질·채소 먼저",
      "하루 20–30분 걷기",
      "발 상처·감염 주의",
    ],
    "불면증·수면장애": [
      "취침/기상 시간 고정",
      "취침 3시간 전 과식·카페인 금지",
      "침대는 수면 전용(폰 금지)",
      "30분 넘게 못 자면 잠자리에서 잠시 나오기",
    ],
    "어깨·목 통증": [
      "고개 숙임 20분마다 스트레칭",
      "온찜질 15분, 높은 베개 피하기",
      "통증 호전 전 무리한 근력운동 금지",
      "스마트폰 눈높이 사용",
    ],
    "심장·호흡·가슴통증": [
      "가슴통증·식은땀·호흡곤란 동반 시 즉시 119",
      "무리한 활동 중단",
      "혈압/맥박 기록",
      "니트로글리세린 처방받았다면 지침 준수",
    ],
    "노안·시력저하": [
      "20-20-20 규칙(20분 작업 후 20초 먼 곳 보기)",
      "실내 습도 40–60%, 인공눈물 사용",
      "최근 2년 내 시력검사 권장",
      "야간 운전 시 눈부심 주의",
    ],
    "치매·기억력 문제": [
      "메모·일정앱 활용",
      "규칙적 생활 + 주 150분 운동",
      "두뇌활동(퍼즐·독서)",
      "복용약 목록 정리(중복/부작용 점검)",
    ],
    "전립선·배뇨 문제": [
      "수분은 낮에 충분히, 잠전 과음 금지",
      "카페인·알코올 줄이기",
      "배뇨 참지 않기",
      "하복부 온찜질",
    ],
    "종합 건강 체크": [
      "주 5일 30분 걷기",
      "채소·단백질 위주 식단",
      "수면 7–8시간",
      "3개월 내 기본검진 고려",
    ],
    "보이스피싱 예방": [
      "모든 링크·앱 설치 금지",
      "계좌/OTP 요구는 100% 사기",
      "금전 요구 시 즉시 112/해당 은행 신고",
      "국번없이 110 상담",
    ],
    "복지·생활지원금": [
      "행정복지센터 방문 상담",
      "정부24·복지로 자격조회",
      "준비: 신분증·통장사본·소득증빙",
      "사칭 문자/앱 주의(링크 금지)",
    ],
  };

  const redFlags = {
    "심장·호흡·가슴통증": ["가슴 중앙 통증이 10분 이상 지속", "호흡곤란/식은땀/구토 동반", "왼쪽 팔·턱으로 퍼지는 통증"],
    "전립선·배뇨 문제": ["소변에 선명한 피", "고열과 오한", "허리통증 + 다리 힘 빠짐"],
    "혈당·당뇨": ["의식저하·구토", "혈당 300mg/dL 이상 반복", "케톤뇨 의심"],
    "혈압 관리": ["수축기 180 또는 이완기 120 이상", "시야장애·마비·언어장애 동반 두통"],
    "관절 통증": ["외상 후 변형/체중부하 불가", "감염 의심 열감·홍반 급증"],
    "불면증·수면장애": ["코골이 + 무호흡", "자살생각/심한 우울"],
    "노안·시력저하": ["갑작스런 시력저하·번쩍임·커튼 내리는 느낌", "안통 + 시력저하 동반"],
    "치매·기억력 문제": ["급격한 인지 저하·섬망", "보행장애/실조 동반"],
    "종합 건강 체크": ["갑작스런 신경학적 증상(마비/언어장애)"],
  };

  const payload = {
    topic,
    checks,
    severity,
    action,
    dept,
    tips: tipsMap[topic] || [],
    redflags: redFlags[topic] || [],
    summary: `주제: ${topic}\n선택: ${checks.join(", ") || "응답 없음"}\n예상 위험도: ${severity}\n권장 조치: ${action}\n권장 진료과: ${dept}`,
  };

  res.json(payload);
});

// ---------- 서버 시작 ----------
const PORT = process.env.PORT || 10000;
app.listen(PORT, () => console.log("server running on " + PORT));
