// ==============================
// ğŸŒ‡ ë…¸ì„ë¹›í•˜ë£¨ AI ì§„ë‹¨ ì„œë²„ (ìµœì¢…ë³¸)
// ==============================
const express = require("express");
const path = require("path");
const app = express();

app.use(express.json());
app.use(express.static(__dirname)); // HTML, CSS, JS ì§ì ‘ ì„œë¹™

// ==============================
// âœ… ê¸°ë³¸ ë¼ìš°íŒ…
// ==============================
app.get("/", (req, res) => {
  res.sendFile(path.join(__dirname, "index.html"));
});

app.get("/question.html", (req, res) => {
  res.sendFile(path.join(__dirname, "question.html"));
});

app.get("/result.html", (req, res) => {
  res.sendFile(path.join(__dirname, "result.html"));
});

// ==============================
// âœ… ì§„ë‹¨ ë¶„ì„ ì—”ì§„
// ==============================
function analyzeTopic(topic, checks) {
  const riskWords = ["ì‹¬í•¨", "ì•…í™”", "ì–´ë ¤ì›€", "ë†’ìŒ", "ìœ„í—˜", "ê°‘ìê¸°", "ìˆ¨", "í†µì¦", "ì €ë¦¼"];
  let riskScore = 0;
  checks.forEach(c => {
    riskWords.forEach(r => {
      if (c.includes(r)) riskScore++;
    });
  });

  // ìœ„í—˜ë„ ê³„ì‚°
  const riskPercent = Math.min(100, riskScore * 10);
  const level =
    riskPercent === 0 ? "ì •ìƒ ë‹¨ê³„" :
    riskPercent <= 30 ? "ê²½ë¯¸í•¨ ë‹¨ê³„" :
    riskPercent <= 60 ? "ì£¼ì˜ ë‹¨ê³„" :
    "ê³ ìœ„í—˜ ë‹¨ê³„";

  // ì´ˆê¸° ë³€ìˆ˜
  let detail = "";
  let supplements = [];
  let advice = [];
  let summary = [];

  // ==============================
  // ğŸ§  ì£¼ì œë³„ ë¶„ì„ ë¡œì§
  // ==============================
  if (topic.includes("í˜ˆì••")) {
    detail = "í˜ˆì•• ê´€ë¦¬ê°€ í•„ìš”í•œ ë‹¨ê³„ì…ë‹ˆë‹¤. í˜„ì¬ í˜ˆì•• ìˆ˜ì¹˜ê°€ ì¼ì •í•˜ì§€ ì•Šë‹¤ë©´ ì‹ì´ì¡°ì ˆê³¼ ê¾¸ì¤€í•œ ì¸¡ì •ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.";
    supplements = ["ì˜¤ë©”ê°€3", "ë§ˆê·¸ë„¤ìŠ˜", "ì½”ì—”ìì„Q10"];
    advice = [
      "ì§œê²Œ ë¨¹ëŠ” ìŠµê´€ì„ ì¤„ì´ê³ , ìˆ˜ë¶„ì„ ì¶©ë¶„íˆ ì„­ì·¨í•˜ì„¸ìš”.",
      "í•˜ë£¨ 30ë¶„ ì´ìƒ ê°€ë²¼ìš´ ìœ ì‚°ì†Œ ìš´ë™ì„ ê¶Œì¥í•©ë‹ˆë‹¤.",
      "í˜ˆì••ì€ ë§¤ì¼ ê°™ì€ ì‹œê°„, ê°™ì€ ìì„¸ë¡œ ì¸¡ì •í•˜ì„¸ìš”."
    ];
    summary = [
      "í˜ˆì•• ìˆ˜ì¹˜ ê´€ë¦¬ í•„ìš”",
      "ì—¼ë¶„ ì„­ì·¨ ì¤„ì´ê¸° ë° ê¾¸ì¤€í•œ ìš´ë™ ê¶Œì¥"
    ];
  }

  else if (topic.includes("í˜ˆë‹¹") || topic.includes("ë‹¹ë‡¨")) {
    detail = "í˜ˆë‹¹ ìˆ˜ì¹˜ê°€ ì¼ì‹œì ìœ¼ë¡œ ìƒìŠ¹í•  ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. ì‹ìŠµê´€ê³¼ ìš´ë™ëŸ‰ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.";
    supplements = ["ì•ŒíŒŒë¦¬í¬ì‚°", "í¬ë¡¬", "ì˜¤ë©”ê°€3"];
    advice = [
      "ë‹¨ ìŒë£Œ, ë¹µ, ì£¼ìŠ¤ ì„­ì·¨ë¥¼ ì¤„ì´ì„¸ìš”.",
      "ì‹ì‚¬ í›„ 20~30ë¶„ ê°€ë²¼ìš´ ê±·ê¸°ê°€ ì¢‹ìŠµë‹ˆë‹¤.",
      "í˜ˆë‹¹ ê¸°ë¡ì„ ê¾¸ì¤€íˆ ë‚¨ê¸°ì„¸ìš”."
    ];
    summary = ["í˜ˆë‹¹ ì¡°ì ˆ í•„ìš”", "ì‹ë‹¨ ì¡°ì ˆ ë° ê·œì¹™ì  ìš´ë™ ê¶Œì¥"];
  }

  else if (topic.includes("ìˆ˜ë©´") || topic.includes("ë¶ˆë©´")) {
    detail = "ìˆ˜ë©´ íŒ¨í„´ì˜ ë¶ˆê· í˜•ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë ˆìŠ¤ì™€ ìˆ˜ë©´ í™˜ê²½ì„ í•¨ê»˜ ê´€ë¦¬í•´ë³´ì„¸ìš”.";
    supplements = ["í…Œì•„ë‹Œ", "ë§ˆê·¸ë„¤ìŠ˜", "GABA"];
    advice = [
      "ì·¨ì¹¨ ì „ ì „ìê¸°ê¸° ì‚¬ìš©ì„ ì¤„ì´ì„¸ìš”.",
      "í•˜ë£¨ ì¼ì •í•œ ìˆ˜ë©´ ì‹œê°„ì„ ìœ ì§€í•˜ì„¸ìš”.",
      "ì ë“¤ê¸° ì „ ë”°ëœ»í•œ ë¬¼ë¡œ ì¡±ìš•ì„ í•´ë³´ì„¸ìš”."
    ];
    summary = ["ìˆ˜ë©´ ì§ˆ ê°œì„  í•„ìš”", "ìˆ˜ë©´ ìœ„ìƒ ë° í™˜ê²½ ê´€ë¦¬ ì¤‘ìš”"];
  }

  else if (topic.includes("ê´€ì ˆ")) {
    detail = "ë¬´ë¦, ì–´ê¹¨ ë“± ê´€ì ˆ ë¶€ìœ„ì— í”¼ë¡œê°€ ëˆ„ì ëœ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. ê¾¸ì¤€í•œ ìŠ¤íŠ¸ë ˆì¹­ì´ í•„ìš”í•©ë‹ˆë‹¤.";
    supplements = ["MSM", "ì½œë¼ê²", "ì˜¤ë©”ê°€3"];
    advice = [
      "ì¥ì‹œê°„ ê°™ì€ ìì„¸ë¥¼ í”¼í•˜ê³  ìì£¼ ì›€ì§ì´ì„¸ìš”.",
      "ì²´ì¤‘ ì¡°ì ˆë„ ê´€ì ˆì— ë¶€ë‹´ì„ ì¤„ì´ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.",
      "ì¹¼ìŠ˜ê³¼ ë‹¨ë°±ì§ˆ ì„­ì·¨ë¥¼ ëŠ˜ë ¤ë³´ì„¸ìš”."
    ];
    summary = ["ê´€ì ˆ ê±´ê°• ê´€ë¦¬ í•„ìš”", "ìŠ¤íŠ¸ë ˆì¹­ ë° ì²´ì¤‘ ê´€ë¦¬ ê¶Œì¥"];
  }

  else if (topic.includes("ì‹œë ¥") || topic.includes("ëˆˆ") || topic.includes("ë…¸ì•ˆ")) {
    detail = "ëˆˆì˜ í”¼ë¡œë„ê°€ ë†’ìŠµë‹ˆë‹¤. ì¥ì‹œê°„ ìŠ¤ë§ˆíŠ¸í°, ëª¨ë‹ˆí„° ì‚¬ìš©ì„ ì¤„ì´ì„¸ìš”.";
    supplements = ["ë£¨í…Œì¸", "ë¹„íƒ€ë¯¼A", "ì•„ìŠ¤íƒ€ì”í‹´"];
    advice = [
      "1ì‹œê°„ë§ˆë‹¤ 10ë¶„ì”© ë¨¼ ê³³ì„ ë°”ë¼ë³´ì„¸ìš”.",
      "ëˆˆì„ ë¹„ë¹„ì§€ ë§ê³  ì¸ê³µëˆˆë¬¼ì„ í™œìš©í•˜ì„¸ìš”."
    ];
    summary = ["ì‹œë ¥ í”¼ë¡œ ì™„í™” í•„ìš”", "ë£¨í…Œì¸ ë° í•­ì‚°í™” ì˜ì–‘ì†Œ ì„­ì·¨ ê¶Œì¥"];
  }

  else if (topic.includes("ê¸°ì–µë ¥") || topic.includes("ì¹˜ë§¤")) {
    detail = "ê¸°ì–µë ¥ ì €í•˜ ë˜ëŠ” ì§‘ì¤‘ë ¥ ë¬¸ì œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê¾¸ì¤€í•œ ë‘ë‡Œí™œë™ì´ ë„ì›€ì´ ë©ë‹ˆë‹¤.";
    supplements = ["ì˜¤ë©”ê°€3", "í¬ìŠ¤íŒŒí‹°ë”œì„¸ë¦°", "ì€í–‰ìì¶”ì¶œë¬¼"];
    advice = [
      "í•˜ë£¨ 20ë¶„ ë…ì„œë‚˜ ê¸€ì“°ê¸°ë¡œ ë‘ë‡Œë¥¼ ìê·¹í•˜ì„¸ìš”.",
      "ê·œì¹™ì ì¸ ìˆ˜ë©´ê³¼ ì‚°ì±…ì´ ê¸°ì–µë ¥ ìœ ì§€ì— ë„ì›€ë©ë‹ˆë‹¤."
    ];
    summary = ["ê¸°ì–µë ¥ ê´€ë¦¬ í•„ìš”", "ë‘ë‡Œ ìê·¹ í™œë™ ê¶Œì¥"];
  }

  else if (topic.includes("ì „ë¦½ì„ ") || topic.includes("ë°°ë‡¨")) {
    detail = "ì „ë¦½ì„  ë˜ëŠ” ë°°ë‡¨ ê¸°ëŠ¥ì— ì•½ê°„ì˜ ë³€í™”ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.";
    supplements = ["ì•„ì—°", "ì˜íŒ”ë©”í† ", "ë¹„íƒ€ë¯¼E"];
    advice = [
      "ì¹´í˜ì¸ê³¼ ì•Œì½”ì˜¬ ì„­ì·¨ë¥¼ ì¤„ì´ì„¸ìš”.",
      "ë¬¼ì„ ìì£¼, ì¡°ê¸ˆì”© ë§ˆì‹œëŠ” ìŠµê´€ì´ ì¢‹ìŠµë‹ˆë‹¤."
    ];
    summary = ["ì „ë¦½ì„  ê±´ê°• ì£¼ì˜", "ìƒí™œìŠµê´€ ê°œì„  í•„ìš”"];
  }

  else {
    detail = "í˜„ì¬ ì „ë°˜ì ì¸ ê±´ê°•ìƒíƒœëŠ” ì–‘í˜¸í•©ë‹ˆë‹¤.";
    supplements = ["ë©€í‹°ë¹„íƒ€ë¯¼", "ìœ ì‚°ê· ", "ì˜¤ë©”ê°€3"];
    advice = [
      "ê· í˜• ì¡íŒ ì‹ë‹¨ì„ ìœ ì§€í•˜ì„¸ìš”.",
      "ì ë‹¹í•œ ìš´ë™ê³¼ ì¶©ë¶„í•œ ìˆ˜ë©´ì´ ì¤‘ìš”í•©ë‹ˆë‹¤."
    ];
    summary = ["ì „ë°˜ì  ì–‘í˜¸", "ê¸°ë³¸ ê±´ê°• ê´€ë¦¬ ìœ ì§€"];
  }

  // ê²°ê³¼ ë°˜í™˜ (opinion í‚¤ í¬í•¨)
  return { topic, level, riskPercent, detail, summary, opinion: advice, supplements };
}

// ==============================
// âœ… API ë¼ìš°í„°
// ==============================
app.post("/analyze", (req, res) => {
  try {
    const { topic, checks } = req.body;
    const result = analyzeTopic(topic, checks);
    res.json(result);
  } catch (error) {
    console.error("âŒ ë¶„ì„ ì˜¤ë¥˜:", error);
    res.status(500).json({ error: "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜" });
  }
});

// ==============================
// âœ… ì„œë²„ ì‹¤í–‰
// ==============================
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`ğŸš€ ë…¸ì„ë¹›í•˜ë£¨ AI ì„œë²„ ì‹¤í–‰ì¤‘ (í¬íŠ¸: ${PORT})`));
