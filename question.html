<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI 문항 자동 생성</title>
  <style>
    body {
      background-color: #f5f7fb;
      font-family: "Noto Sans KR", sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .box {
      background: #fff;
      padding: 35px;
      border-radius: 12px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.08);
      width: 90%;
      max-width: 450px;
      text-align: center;
    }
    h2 {
      color: #1e293b;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .question {
      font-size: 17px;
      font-weight: 600;
      color: #334155;
      margin-bottom: 20px;
    }
    .option {
      background-color: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
      cursor: pointer;
      font-size: 15px;
      transition: 0.2s;
    }
    .option:hover {
      background-color: #2563eb;
      color: white;
      border-color: #1e40af;
    }
    .progress {
      font-size: 13px;
      color: #64748b;
      margin-top: 15px;
    }
    .error {
      color: #dc2626;
      font-size: 14px;
      margin-top: 10px;
      display: none;
      background: #fee2e2;
      border-radius: 6px;
      padding: 8px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h2 id="title">AI 자동 설문</h2>
    <div id="question" class="question"></div>
    <div id="options"></div>
    <div id="progress" class="progress"></div>
    <div id="errorBox" class="error"></div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const topic = params.get("topic");
    const questionEl = document.getElementById("question");
    const optionsEl = document.getElementById("options");
    const progressEl = document.getElementById("progress");
    const errorBox = document.getElementById("errorBox");
    const title = document.getElementById("title");

    if (!topic) {
      questionEl.textContent = "❌ 주제가 선택되지 않았습니다.";
      throw new Error("topic missing");
    }

    title.textContent = `${topic} 진단`;

    // ✅ 주제별 문항
    const generateQuestions = (topic) => {
      if (topic.includes("자동차") || topic.includes("견적")) {
        return [
          "현재 차량을 보유 중이신가요?",
          "구매 방식은 어떤 것을 선호하시나요?",
          "월 차량 예산은 어느 정도인가요?",
          "선호하는 차량 브랜드가 있나요?",
          "차량 구매 또는 교체 시기는 언제인가요?",
          "보험료나 유지비에 대한 부담이 있나요?",
          "전기차나 하이브리드 차량에 관심이 있나요?",
          "차량 구매 시 가장 중요하게 보는 요소는 무엇인가요?"
        ];
      } else if (topic.includes("보험")) {
        return [
          "현재 가입한 보험이 몇 개 있나요?",
          "보험료가 부담스럽다고 느끼시나요?",
          "최근 보험 리모델링을 고려한 적이 있나요?",
          "갱신형 보험을 보유하고 계신가요?",
          "보험금 청구 경험이 있으신가요?",
          "필요 없는 특약이 있다고 느끼시나요?",
          "가족 구성원의 보험도 함께 관리 중인가요?",
          "보험 보장 범위를 정확히 알고 계신가요?"
        ];
      } else {
        return [
          "불편하거나 자주 겪는 증상은 무엇인가요?",
          "이 문제가 언제부터 있었나요?",
          "하루 중 증상이 가장 심한 시간대는?",
          "생활습관 중 영향을 주는 요소가 있나요?",
          "통증 또는 불편감의 강도는 어느 정도인가요?",
          "스트레스나 피로가 관련되어 있나요?",
          "증상이 일상생활에 얼마나 영향을 주나요?",
          "최근 복용 중인 약물 또는 치료가 있나요?"
        ];
      }
    };

    // ✅ 선택지 자동 생성
    const generateOptions = (topic, index) => {
      if (topic.includes("자동차") || topic.includes("견적")) {
        const carOptions = [
          ["보유 중", "무보유", "렌트", "리스", "가족 차량", "기타"],
          ["현금", "할부", "리스", "렌트", "모름", "상담 원함"],
          ["30만원 이하", "30~50만원", "50~80만원", "80~100만원", "100만 원 이상", "일시불"], // ✅ 수정 완료
          ["현대", "기아", "BMW", "벤츠", "제네시스", "기타"],
          ["즉시", "3개월 이내", "6개월 이내", "1년 이내", "1년 이상", "미정"],
          ["부담 없음", "보통", "조금 부담됨", "많이 부담됨", "모름", "기타"],
          ["매우 관심 있음", "관심 있음", "보통", "관심 없음", "모름", "기타"],
          ["가격", "연비", "디자인", "브랜드", "안전성", "유지비"]
        ];
        return carOptions[index] || ["예", "아니오", "기타"];
      }
      else if (topic.includes("보험")) {
        const insuranceOptions = [
          ["1개", "2~3개", "4~5개", "6개 이상", "모름", "없음"],
          ["예", "아니오", "부분적으로", "모름", "상담 원함", "관심 없음"],
          ["예", "아니오", "고려 중", "이미 진행함", "모름", "기타"],
          ["예", "아니오", "모름", "갱신 중", "만기 예정", "기타"],
          ["있음", "없음", "진행 중", "보류 중", "모름", "기타"],
          ["있음", "없음", "모름", "조정 필요", "삭제 예정", "기타"],
          ["예", "아니오", "일부만", "모름", "가족 포함", "기타"],
          ["정확히 알고 있음", "대략 알고 있음", "잘 모름", "관심 없음", "상담 원함", "기타"]
        ];
        return insuranceOptions[index] || ["예", "아니오", "기타"];
      }
      else {
        return ["예", "아니오", "가끔", "자주", "모름", "기타"];
      }
    };

    const questions = generateQuestions(topic);
    let current = 0;
    const answers = [];

    function renderQuestion() {
      const q = questions[current];
      const opts = generateOptions(topic, current);
      questionEl.textContent = `문항 ${current + 1}. ${q}`;
      optionsEl.innerHTML = "";
      opts.forEach(opt => {
        const btn = document.createElement("div");
        btn.className = "option";
        btn.textContent = opt;
        btn.onclick = () => {
          answers.push(opt);
          current++;
          if (current < questions.length) {
            renderQuestion();
          } else {
            submitAnswers();
          }
        };
        optionsEl.appendChild(btn);
      });
      progressEl.textContent = `문항 ${current + 1} / ${questions.length}`;
    }

    async function submitAnswers() {
      try {
        const res = await fetch("https://noeulbitharu.onrender.com/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic, answers })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error);
        localStorage.setItem("aiResult", JSON.stringify(data));
        window.location.href = "result.html";
      } catch (err) {
        errorBox.style.display = "block";
        errorBox.textContent = "결과 전송 실패. 다시 시도해주세요.";
      }
    }

    renderQuestion();
  </script>
</body>
</html>
