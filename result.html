<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>AI 진단 결과</title>
<style>
  :root{--bg:#0d1420;--panel:#121a26;--panel2:#182235;--line:#2a3a55;--brand:#6ba7ff;--muted:#9fb1cf;--white:#fff;}
  body{font-family:"Pretendard","Noto Sans KR",sans-serif;background:var(--bg);color:var(--white);margin:0}
  .wrap{max-width:1180px;margin:0 auto;padding:26px 48px 44px} /* 좌우 여백 강화 */
  h1{margin:6px 0 18px;color:#98c2ff;font-size:1.6rem}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:28px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 0 12px rgba(0,0,0,.35);padding:22px}
  .card.alt{background:var(--panel2)}
  .hl{margin:0 0 12px;border-left:4px solid var(--brand);padding-left:10px}
  .muted{color:var(--muted)}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 12px;margin:8px 0 14px}
  .bar{height:6px;background:#22324b;border-radius:4px;overflow:hidden;margin:6px 0 14px}
  .bar>span{display:block;height:100%;width:0;background:var(--brand);transition:width .6s}
  ul{margin:8px 0 0 18px}
  li{margin:4px 0}
  .aff{display:flex;align-items:flex-start;gap:12px;padding:12px;border:1px solid var(--line);border-radius:12px;background:#1a2334;cursor:pointer;transition:.2s}
  .aff + .aff{margin-top:10px}
  .aff:hover{transform:translateY(-2px);background:#20304a}
  .aff img{width:30px;height:30px}
  .tiny{margin-top:12px;font-size:.82rem;color:#8796b3;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <h1>노을빛하루 AI 진단 결과</h1>

    <div class="grid">
      <!-- LEFT: 지표/상세/요약/전문가 -->
      <section class="card" id="left">
        <h2 class="hl">AI 진단결과</h2>

        <div class="kv">
          <div class="muted">주제</div><div id="kv-topic">-</div>
          <div class="muted">진단 단계</div><div id="kv-level">-</div>
          <div class="muted">총 응답 수</div><div id="kv-count">0개</div>
          <div class="muted">위험단어 수</div><div id="kv-riskwords">0개</div>
          <div class="muted">위험도 지표</div>
          <div><span id="kv-riskscore">0</span>/100</div>
        </div>

        <div class="bar"><span id="riskBar"></span></div>

        <h3 class="hl" style="border-left-color:#4f7ed9">상세 진단</h3>
        <div id="detail" class="muted">상세 진단 데이터가 없습니다.</div>

        <h3 class="hl" style="border-left-color:#4f7ed9">요약</h3>
        <ul id="summary"><li class="muted">요약 데이터 없음</li></ul>

        <h3 class="hl" style="border-left-color:#4f7ed9">전문가 의견</h3>
        <ul id="opinion"><li class="muted">전문가 의견 데이터 없음</li></ul>
      </section>

      <!-- RIGHT: 제휴상품/제휴보험 -->
      <aside class="card alt" id="right">
        <h2 class="hl">제휴상품 (필요하신 영양제)</h2>
        <div id="supps"></div>

        <h2 class="hl" style="margin-top:18px">제휴보험 (체크해 보세요)</h2>
        <div id="ins"></div>

        <div class="tiny">본 제휴상품 및 제휴보험은 소정의 수수료를 지급받습니다.</div>
      </aside>
    </div>
  </div>

<script>
(function(){
  // 기존 구조: localStorage 호환 유지
  const topicLS   = localStorage.getItem("aiTopic");
  const answersLS = localStorage.getItem("aiAnswers");
  const resultLS  = localStorage.getItem("aiResult");

  const topic   = (resultLS && JSON.parse(resultLS).topic) || topicLS || "종합 건강 체크";
  const answers = answersLS ? JSON.parse(answersLS) : [];
  const result  = resultLS ? JSON.parse(resultLS) : {};

  // ===== 좌측 상단 Key-Values =====
  const $ = id => document.getElementById(id);
  $("kv-topic").textContent     = topic;
  $("kv-level").textContent     = result.level || "mild";
  $("kv-count").textContent     = `${answers.length}개`;
  $("kv-riskwords").textContent = `${result.riskWords ?? 0}개`;
  $("kv-riskscore").textContent = result.riskScore ?? 0;
  $("riskBar").style.width      = ((result.riskScore ?? 0) + "%");

  // ===== 상세 진단 (최소 15줄 보장) =====
  const detailTarget = $("detail");
  const detailText = (result.detail && String(result.detail).trim()) || "";
  if (detailText) {
    detailTarget.textContent = detailText;
  } else {
    const base = [
      `현재 주제는 '${topic}'이며, 응답 데이터를 기반으로 AI 분석을 수행했습니다.`,
      `위험도는 ${(result.level || "mild").toUpperCase()} 수준으로 평가되며, 일상 관리 중심 접근이 적합합니다.`,
      `응답 수는 ${answers.length}개이며, 위험 신호 단어 감지는 ${result.riskWords ?? 0}개로 파악됩니다.`,
      `급성 악화 소견은 크지 않으나, 반복·지속 시 추가 점검이 권장됩니다.`,
      `생활 패턴 점검과 수면 위생 확보가 도움이 됩니다.`,
      `균형 잡힌 식단과 수분 섭취, 가벼운 유산소 활동을 권합니다.`,
      `스트레스 관리는 증상 완화에 긍정적 영향을 줍니다.`,
      `증상이 심화되거나 새로운 증상이 동반될 경우 빠르게 전문의 상담을 권장합니다.`,
      `최근 경향이 유지될 경우 정기 검진을 통해 경과를 확인하세요.`,
      `자극적인 음식·과음·과로는 피하고 충분한 휴식을 취하세요.`,
      `필요 시 보조 영양제를 통해 부족영양을 보완할 수 있습니다.`,
      `평상시와 다른 양상의 통증·호흡곤란·어지럼이 나타나면 즉시 진료받으세요.`,
      `자기 관찰(수면·식사·활동 기록)을 통해 변화 추이를 체크하세요.`,
      `가족과 소통하며 안전망을 마련하면 관리가 수월해집니다.`,
      `전반적으로 양호하나, 세부적 관리는 계속 필요합니다.`
    ];
    detailTarget.textContent = base.join("\n");
  }

  // ===== 요약 (7줄 목표) =====
  const summaryEl = $("summary");
  const sumArray = Array.isArray(result.summary) ? result.summary : [];
  if (sumArray.length) {
    summaryEl.innerHTML = sumArray.map(s => `<li>${s}</li>`).join("");
  } else {
    const fallback = [
      `주제: ${topic}`,
      `위험도 수준: ${(result.level || "mild").toUpperCase()}`,
      `응답 수: ${answers.length}개`,
      `위험단어 감지: ${result.riskWords ?? 0}개`,
      `현재 상태는 비교적 안정적이며 생활 관리 위주 접근 권장`,
      `증상 지속·악화 시 전문의 상담 권장`,
      `정기 점검과 습관 관리로 안정적 유지 가능`
    ];
    summaryEl.innerHTML = fallback.map(s => `<li>${s}</li>`).join("");
  }

  // ===== 전문가 의견 (2줄 목표) =====
  const opinionEl = $("opinion");
  const opArray = Array.isArray(result.opinion) ? result.opinion
                : (Array.isArray(result.advice) ? result.advice : []);
  if (opArray.length) {
    opinionEl.innerHTML = opArray.map(s => `<li>${s}</li>`).join("");
  } else {
    const fallback = [
      `특별히 긴급한 위험 신호는 크지 않습니다.`,
      `생활관리 지속과 정기 검진을 통해 상태를 안정적으로 유지하세요.`
    ];
    opinionEl.innerHTML = fallback.map(s => `<li>${s}</li>`).join("");
  }

  // ===== 제휴상품/보험: affiliate.json 로드 =====
  fetch("/affiliate.json")
    .then(r => r.json())
    .then(map => {
      // 제휴상품 (주제 키)
      const suppList = map[topic] || [];
      const supps = $("supps");
      if (!suppList.length) {
        supps.innerHTML = `<div class="muted">해당 주제에 등록된 제휴상품이 없습니다.</div>`;
      } else {
        suppList.slice(0,3).forEach(item => {
          const div = document.createElement("div");
          div.className = "aff";
          div.innerHTML = `
            <img src="https://cdn-icons-png.flaticon.com/512/2965/2965567.png" alt="supp">
            <div>
              <div><strong>${item.name}</strong></div>
              <div class="muted">${item.desc || ""}</div>
              <div class="muted">쿠팡 바로가기</div>
            </div>`;
          div.onclick = () => window.open(item.link, "_blank");
          supps.appendChild(div);
        });
      }

      // 제휴보험 (고정 키: "보험상품")
      const insList = map["보험상품"] || [];
      const ins = $("ins");
      if (!insList.length) {
        ins.innerHTML = `<div class="muted">현재 표시할 보험 정보가 없습니다.</div>`;
      } else {
        insList.forEach(item => {
          const div = document.createElement("div");
          div.className = "aff";
          div.innerHTML = `
            <img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" alt="ins">
            <div>
              <div><strong>${item.name}</strong></div>
              <div class="muted">${item.desc || ""}</div>
              <div class="muted">바로가기</div>
            </div>`;
          div.onclick = () => window.open(item.link, "_blank");
          ins.appendChild(div);
        });
      }
    })
    .catch(()=> {
      $("supps").innerHTML = `<div class="muted">제휴상품 정보를 불러오지 못했습니다.</div>`;
      $("ins").innerHTML   = `<div class="muted">보험 정보를 불러오지 못했습니다.</div>`;
    });
})();
</script>
</body>
</html>
