<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>문항 진행</title>
<style>
  body{margin:0;background:#f5f7fb;font-family:"Noto Sans KR",system-ui}
  .wrap{max-width:740px;margin:40px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 2px 8px rgba(15,23,42,.05);padding:20px}
  h2{margin:0 0 6px;color:#0f172a;font-size:20px}
  .sub{color:#475569;margin-bottom:14px}
  .opt{display:block;width:100%;background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:14px;margin:10px 0;cursor:pointer;text-align:center}
  .opt:hover{background:#eef2ff;border-color:#c7d2fe}
  .step{color:#64748b;margin-top:6px;text-align:center}
  .err{margin-top:12px;color:#b91c1c;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2 id="title"></h2>
    <div class="sub" id="desc"></div>
    <div id="opts"></div>
    <div class="step" id="step"></div>
    <div class="err" id="err"></div>
  </div>
</div>

<script>
const qs=(k)=>new URLSearchParams(location.search).get(k)||"";
const topic=qs("topic");
const title=document.getElementById("title");
const desc=document.getElementById("desc");
const optsDiv=document.getElementById("opts");
const step=document.getElementById("step");
const err=document.getElementById("err");

let Q=[], A=[], i=0;

async function loadSurvey(){
  try{
    if(!topic){title.textContent="주제가 선택되지 않았습니다.";return;}
    const r=await fetch(`/api/survey/${encodeURIComponent(topic)}`);
    const data=await r.json();
    if(!r.ok) throw new Error(data?.error||"문항 로드 실패");
    Q=data.questions||[];
    i=0; A=[]; render();
  }catch(e){
    title.textContent="문항 불러오기 오류";
    err.textContent=e.message||"다시 시도해주세요.";
  }
}

function render(){
  if(i>=Q.length) return submit();
  const q=Q[i];
  title.textContent=`${topic} 진단`;
  desc.textContent=`문항 ${i+1}. ${q.text}`;
  optsDiv.innerHTML="";
  q.options.forEach(op=>{
    const b=document.createElement("button");
    b.className="opt"; b.textContent=op;
    b.onclick=()=>{ A.push(`${q.text}=${op}`); i++; render(); };
    optsDiv.appendChild(b);
  });
  step.textContent=`문항 ${i+1} / ${Q.length}`;
}

async function submit(){
  title.textContent="분석 중…";
  desc.textContent="응답을 바탕으로 결과를 만들고 있습니다.";
  optsDiv.innerHTML=""; step.textContent="잠시만 기다려주세요.";
  err.textContent="";

  try{
    const r=await fetch("/api/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic,answers:A})});
    const data=await r.json();
    if(!r.ok||!data.success) throw new Error(data?.error||"결과 생성 실패");
    localStorage.setItem("aiResult", JSON.stringify(data));
    location.href="result.html";
  }catch(e){
    err.textContent="결과 전송 실패. 다시 시도해주세요.";
    const retry=document.createElement("button");
    retry.className="opt"; retry.textContent="다시 시도";
    retry.onclick=submit;
    optsDiv.appendChild(retry);
  }
}

loadSurvey();
</script>
</body>
</html>
